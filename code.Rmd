---
title: "3D biomimetic niche modulates embryo development in vitro"
output: html_document
date: "2025-11-05"
---

```{r setup, include=FALSE}
library(Seurat)
library(harmony)
library(ggplot2)
library(SingleR)
library(tidyverse)
library(patchwork)
library(MySeuratWrappers)
library(pheatmap)
library(ComplexHeatmap)
library(clustree)
E8 <- CreateSeuratObject(counts = Read10X("cellranger/E8-5/outs/filtered_feature_bc_matrix/"), project = "E8", min.cells = 3, min.features = 200)
E6 <- CreateSeuratObject(counts = Read10X("cellranger/E6-5/outs/filtered_feature_bc_matrix/"), project = "E6", min.cells = 3, min.features = 200)
E8L <- CreateSeuratObject(counts = Read10X("cellranger/E8-5-L/outs/filtered_feature_bc_matrix/"), project = "E8L", min.cells = 3, min.features = 200)
sce <- merge(E8,y = c(E8L,E6),add.cell.ids = c("E8","E8L","E6"),project = "mm10") 
table(sce@meta.data$orig.ident)
sce[["percent.mt"]] <- PercentageFeatureSet(sce, pattern = "^mt-")
VlnPlot(object = sce, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size = 0)
sce <- subset(x = sce, subset = nFeature_RNA > 200 & nFeature_RNA < 8000 & percent.mt < 8)
sce <- NormalizeData(sce, normalization.method = "LogNormalize", scale.factor = 10000)
sce <- FindVariableFeatures(sce, selection.method = "vst", nfeatures = 3000)
all.genes <- rownames(sce)
sce <- ScaleData(sce, features = all.genes)
sce <- RunPCA(sce, features = VariableFeatures(object = sce))
DimPlot(sce, reduction = "pca",group.by = 'orig.ident')
ElbowPlot(object = sce,ndims = 50,reduction = "pca")
pcSelect = 20
sce <- FindNeighbors(sce, dims = 1:20)
sce <- FindClusters(sce, resolution = 2.6)
sce <- RunUMAP(sce, dims = 1:20)
sce$state <- sce$orig.ident
sce$state <- recode(sce$state,
                    'E8' = 'state1',
                    'E6' = 'state1',
                    'E8L' = 'state2')
sce_harmony <- RunHarmony(sce, group.by.vars="orig.ident") 
ElbowPlot(object = sce_harmony,ndims = 50,reduction = "pca")
sce_harmony <- sce_harmony %>% 
  RunUMAP(reduction = "harmony", dims = 1:20) %>% 
  FindNeighbors(reduction = "harmony", dims = 1:20) %>% 
  FindClusters(resolution = 1.5) %>% 
  identity()
refdata <- readRDS('singerR/refdata-se.rds')
testdata <- GetAssayData(sce_harmony, slot="data")
clusters <- sce_harmony@meta.data$seurat_clusters
cellpred <- SingleR(test = testdata, ref = refdata, labels = refdata@metadata$celltype,
                      method = "cluster", clusters = clusters,
                      assay.type.test = "logcounts", assay.type.ref = "logcounts")
celltype = data.frame(ClusterID=rownames(cellpred), celltype=cellpred$labels, stringsAsFactors = F)
celltype
for(i in 1:nrow(celltype)){
  sce_harmony@meta.data[which(sce_harmony@meta.data$seurat_clusters == celltype$ClusterID[i]),'celltype_nobatch'] <- celltype$celltype[i]}
sce_harmony$state <- sce_harmony$orig.ident
sce_harmony$state <- recode(sce_harmony$state,
                        'E8' = 'E8.5',
                        'E6' = 'E6.5',
                        'E8L' = 'D9')
p1 = FeaturePlot(sce_harmony, features = 'Nkx2-5', pt.size = 1.2,max.cutoff = 0.5,min.cutoff = 0)
ggsave(p1,filename = 'Nkx2-5_FeaturePlot.pdf',width =10,height =10)
tt = subset(sce_harmony, subset = Cd34 > 0)
p1 = VlnPlot(tt, 'Kdr',pt.size = 0,group.by = 'origident')+scale_x_discrete(limits=c("E6.5","E8.5","E8.5-like"))+xlab(" ") + theme(axis.text.x = element_text(angle = 0),legend.position = "none")
ggsave(p1,filename = 'Endothelium_Kdr.pdf',width =4,height =4)
sce_harmony$celltype <- sce_harmony$celltype_nobatch
sce_harmony$celltype <- recode(sce_harmony$celltype,
                    'Allantois' = 'Allantois',
                    'Blood progenitors 2' = 'Blood progenitors',
                    'Cardiomyocytes' = 'Cardiomyocytes',
                    'Endothelium' = 'Endothelium',
                    'Epiblast' = 'Epiblast',
                    'Erythroid3' = 'Erythroid',
                    'ExE ectoderm' = 'ExE ectoderm',
                    'ExE endoderm' = 'ExE endoderm',
                    'ExE mesoderm' = 'ExE mesoderm',
                    'Forebrain/Midbrain/Hindbrain' = 'Forebrain/Midbrain/Hindbrain',
                    'Gut' = 'Gut',
                    'Mesenchyme' = 'Mesenchyme',
                    'Neural crest' = 'Neural crest',
                    'NMP' =  'Neuromesodermal progenitor',
                    'Paraxial mesoderm' = 'Paraxial mesoderm',
                    'Primitive Streak' = 'Primitive Streak',
                    'Spinal cord' = 'Spinal cord',
                    'Surface ectoderm' = 'Surface ectoderm',
                    'Visceral endoderm' = 'Visceral endoderm')
library(dplyr)
library(ggplot2)
library(ggrepel)
getwd()
KEGG_dataset <- read.table(file ="GO_filter.txt",
                           header = TRUE, sep = "\t")
KEGG_dataset$Term <- factor(KEGG_dataset$Term,levels = rev(KEGG_dataset$Term)) # 将Pathway列转化为因子型
#图片背景设定
mytheme <- theme(axis.title=element_text(face="bold", size=14,colour = 'black'), #坐标轴标题
                 axis.text=element_text(face="bold", size=14,colour = 'black'), #坐标轴标签
                 axis.line = element_line(size=0.5, colour = 'black'), #轴线
                 panel.grid.major=element_line(colour=NA),#去除主要网格线
                 panel.grid.minor = element_blank(),#去除次要网格线
                 panel.background = element_rect(color='black'), #绘图区边框
                 legend.key = element_blank() #关闭图例边框
)

#绘制KEGG气泡图
p <- ggplot(KEGG_dataset,aes(x=Fold_Enrichment,y=Term,colour=-1*log10(PValue),size=Count))+
  geom_point()+
  scale_size(range=c(2, 8))+
  scale_colour_gradient(low = "blue",high = "red")+
  theme_bw()+
  ylab("GO Pathway Terms")+
  xlab("Gene Ratio")+
  labs(color=expression(-log[10](PValue)))+
  theme(legend.title=element_text(size=14), legend.text = element_text(size=14))+
  theme(axis.title.y = element_text(margin = margin(r = 50)),axis.title.x = element_text(margin = margin(t = 20)))+
  theme(axis.text.x = element_text(face ="bold",color="black",angle=0,vjust=1))
#plot <- p+mytheme+ theme_classic()
plot <- p+mytheme
plot
ggsave(plot,filename = "GO_2.pdf",width = 10,height = 6,dpi=300)
Idents(sce_harmony) <- sce_harmony$neworig
sub <- subset(x = sce_harmony, idents = c('D9','E8.5'))
p1 <- VlnPlot(sub, features = 'Gpx3',pt.size = 0,y.max = 5.5) + scale_fill_manual(values = c("#496989","#A8CD9F"))
ggsave(p1,filename = "./pdf_final/Gpx3_VlnPlot.pdf",width = 3.2353,height = 7.3) # 下调专用图像参数

p1 <- VlnPlot(sub, features = 'Tcof1',pt.size = 0,y.max = 4.5) + scale_fill_manual(values = c("#496989","#A8CD9F"))
ggsave(p1,filename = "./pdf_final/Tcof1_VlnPlot.pdf",width = 3.2353,height = 7.3) # 上调专用图像参数
sce <- readRDS('sce_harmony_final.rds')
cluster = table(sce$neworig,sce@meta.data$celltype)
cell.prop<-as.data.frame(prop.table(cluster))
colnames(cell.prop) <- c('stage',"celltype","proportion")
#cell.prop$proportion <- percent(cell.prop$proportion, accuracy =1)

# 横向条形图
p2 = cell.prop %>%
  mutate(stage = factor(stage, levels = c("E6.5","E8.5","D9"))) %>%
  ggplot(aes(proportion,stage,fill=celltype))+
  geom_bar(stat="identity",position="fill")+
  ggtitle("")+
  theme_bw()+
  #theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  theme(axis.ticks.length=unit(0.5,'cm'))+
  labs(x="Percentage of cells(%)",y = "")+
  guides(fill=guide_legend(title=NULL))
p3 <- p2 + scale_fill_manual( values = c("#b47fd0","#f4e159","#af1d1c","#ecc57d","#0073b5","#cd732d","#958d8f","#d5d3d0","#8a4ed2","#1192ff","#2d59d9","#ebbcd0","#a1dfff","#b0ca7b","#d44276","#2da96a","#60b3ff","#a2d0a1","#a9948f"))
# 保存
ggsave(p3,filename = "./pdf/table.pdf",width = 16,height = 10)

# 细分群 
Idents(sce_harmony) = sce_harmony@meta.data$celltype_nobatch
Car = subset(x = sce_harmony, idents = c("Cardiomyocytes"))
Car <- NormalizeData(Car, normalization.method = "LogNormalize", scale.factor = 10000)
Car <- FindVariableFeatures(Car, selection.method = "vst", nfeatures = 3000)
all.genes <- rownames(Car)
Car <- ScaleData(Car, features = all.genes)
Car <- RunPCA(Car, features = VariableFeatures(object = Car))
DimPlot(Car, reduction = "pca",group.by = 'orig.ident')
ElbowPlot(object = Car,ndims = 50,reduction = "pca")
pcSelect = 14
Car <- FindNeighbors(Car, dims = 1:pcSelect)
Car <- FindClusters(Car, resolution = 0.1)
Car <- RunUMAP(Car, dims = 1:pcSelect)
Car <- RunUMAP(Car, dims = 1:pcSelect)
DimPlot(Car, group.by="orig.ident", repel=T, label=T, label.size=5, reduction='umap')
DimPlot(Car, group.by="celltype", repel=T, label=T, label.size=5, reduction='umap')
marker = c('Tbx5','Hcn4','Nkx2-5','Hand1','Tbx1','Six1','Six2')
Idents(object = Car) <- 'RNA_snn_res.0.17'
new.cluster.ids <- c("BMF", "pSHF", "AHF")
names(new.cluster.ids) <- levels(Car)
celltype = data.frame(ClusterID=names(new.cluster.ids),celltype=new.cluster.ids, stringsAsFactors = F)
Car@meta.data$celltype = "NA"
for(i in 1:nrow(celltype)){
  Car@meta.data[which(Car@meta.data$RNA_snn_res.0.17 == celltype$ClusterID[i]),'celltype'] <- celltype$celltype[i]}
saveRDS(Car,'Car.rds')
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
